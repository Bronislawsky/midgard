#!/usr/bin/env bash
# file : ./midgard
set -euo pipefail
export MIDGARD_VERSION="1.0.0"
#------------------------------------------------------------------------------
cat <<'EOF'

         .__    .___                      .___
   _____ |__| __| _/ _________ _______  __| _/
  /     \|  |/ __ | / ___\__  \\_  __ \/ __ |
 |  Y Y  \  / /_/ |/ /_/  > __ \|  | \/ /_/ |
 |__|_|  /__\____ |\___  (____  /__|  \____ |
       \/        \/_____/     \/           \/

EOF
echo -e " Version : ${MIDGARD_VERSION}\n"

# midgard â€” main launcher
#------------------------------------------------------------------------------

# Guard: only code sourced from this launcher is allowed to run
export MIDGARD_MAIN="1"

# Source helpers (colors, status_* functions, etc.)
source "$(dirname "$0")/scripts/helper"

# Source crypt for encrypting / decrypting
source "$(dirname "$0")/scripts/crypt"

# Load config file
MIDGARD_CONFIG_FILE="$(dirname "$0")/config/midgard.conf"
status_start "Loading config file ${MIDGARD_CONFIG_FILE} ..."
if [[ ! -f "$MIDGARD_CONFIG_FILE" ]]; then
    status_fail
    echo "    - config file not found"
    exit 1
fi

# shellcheck disable=SC1090
if ! source "$MIDGARD_CONFIG_FILE"; then
    status_fail
    echo "    - could not source $MIDGARD_CONFIG_FILE"
    exit 1
else
    status_ok
fi

# Validate config (uses already-loaded variables, dies if invalid)
source "$(dirname "$0")/scripts/load-config"

# Check binaries + sudo -n (dies on error)
source "$(dirname "$0")/scripts/binary-check"

# Site configuration helper
source "$(dirname "$0")/scripts/inspect-site"

# Site management helpers (defines site_list/site_enable/site_disable)
source "$(dirname "$0")/scripts/site"

# fast-path subcommands that don't need global config
case "${1-}" in
  encstr)
    midgard_encstr; exit 0 ;;
  decstr)
     midgard_decstr; exit 0 ;;
  create-site)
    shift
    source "$(dirname "$0")/scripts/create-site" "$@"
    exit 0
    ;;
  inspect-site)
    shift
    inspect_site_main "$@"
    exit $?
    ;;
  site)
    shift
    sub="${1-}"; shift || true
    case "${sub:-}" in
      list)
        site_list; exit $? ;;
      enable)
        site_enable "${1-}"; exit $? ;;
      disable)
        site_disable "${1-}"; exit $? ;;
      *)
        echo "Usage: ./midgard site {list|enable <site>|disable <site>}"; exit 1 ;;
    esac
    ;;
esac

info "Starting midgard run with verbosity=$VERBOSITY"

#!/usr/bin/env bash
# file : ./scripts/theme-checksums
#------------------------------------------------------------------------------
#
#         .__    .___                      .___
#   _____ |__| __| _/ _________ _______  __| _/
#  /     \|  |/ __ | / ___\__  \\_  __ \/ __ |
# |  Y Y  \  / /_/ |/ /_/  > __ \|  | \/ /_/ |
# |__|_|  /__\____ |\___  (____  /__|  \____ |
#       \/        \/_____/     \/           \/
#
# theme-checksums
#   - Uses local cache JSON in ./theme-checksums/<slug>/<version>.json
#   - (No official auto-fetch for themes; if cache missing -> PRIVATE)
#   - Compares against local theme files to detect:
#       * missing files (in JSON but not on disk)
#       * mismatched hashes (md5 differs)
#       * extra files (on disk but not in JSON)  <-- potential injections
#   - Appends overall status to reports/$EPOCH_TIMESTAMP/<site>.report
#   - Logs detailed differences to logs/$EPOCH_TIMESTAMP/<site>.log
#------------------------------------------------------------------------------

# Safety guard
if [[ "${MIDGARD_MAIN:-}" != "1" ]]; then
  echo "This script must be sourced from the midgard launcher." >&2
  return 1 2>/dev/null || exit 1
fi

#------------------------------------------------------------------------------
# Utilities
#------------------------------------------------------------------------------

# name-ref getter: _get <assoc_array_name> <key>
_get() {
  local __arr="$1" __key="$2"
  declare -n __ref="$__arr"
  printf '%s' "${__ref[$__key]-}"
}

#------------------------------------------------------------------------------
# Version detection (themes)
#------------------------------------------------------------------------------

# Extract "Version: x.y.z" from style.css header (first ~120 lines).
_tc_version_from_style() {
  local css_file="${1:-}"
  [[ -r "$css_file" ]] || return 0
  awk 'NR>120{exit}
       BEGIN{IGNORECASE=1}
       /^[[:space:]]*(\*|#|\/\/)?[[:space:]]*Version[[:space:]]*:/{
         sub(/^[[:space:]]*(\*|#|\/\/)?[[:space:]]*Version[[:space:]]*:[[:space:]]*/, "", $0)
         gsub(/[[:space:]]+$/, "", $0)
         print $0; exit
       }' "$css_file"
}

# Themes commonly keep version only in style.css. Try that; fall back to readme.txt "Stable tag".
_tc_detect_theme_version() {
  local theme_dir="${1:-}"
  local ver f

  f="${theme_dir%/}/style.css"
  if [[ -f "$f" ]]; then
    ver="$(_tc_version_from_style "$f")"
    [[ -n "$ver" ]] && { printf '%s\n' "$ver"; return 0; }
  fi

  f="${theme_dir%/}/readme.txt"
  if [[ -f "$f" ]]; then
    ver="$(
      awk 'BEGIN{IGNORECASE=1}
           /^[[:space:]]*Stable[[:space:]]+tag[[:space:]]*:/{
             sub(/^[[:space:]]*Stable[[:space:]]+tag[[:space:]]*:[[:space:]]*/, "", $0)
             gsub(/[[:space:]]+$/, "", $0)
             print $0; exit
           }' "$f"
    )"
    [[ -n "$ver" ]] && { printf '%s\n' "$ver"; return 0; }
  fi

  printf 'unknown\n'
}

#------------------------------------------------------------------------------
# Cache + compare
#------------------------------------------------------------------------------

# Return path for cache file (does not ensure it exists)
_tc_cache_path() {
  local slug="$1" ver="$2"
  printf './theme-checksums/%s/%s.json\n' "$slug" "$ver"
}

# Return the path to the cached checksum JSON; no auto-fetch (themes lack an official API)
_tc_cache_file_for() {
  local slug="$1" ver="$2"
  local path="$(_tc_cache_path "$slug" "$ver")"
  [[ -f "$path" ]] && { printf '%s\n' "$path"; return 0; }
  return 1
}

# Compare JSON checksums to on-disk theme files.
# Prints one summary line; returns:
#   0 OK
#   1 FAIL (missing/mismatched/extra or errors)
#   2 PRIVATE (no cache JSON)
_tc_compare_from_cache() {
  local theme_dir="$1" slug="$2" ver="$3"
  local cache
  if ! cache="$(_tc_cache_file_for "$slug" "$ver")"; then
    printf "%s %s PRIVATE\n" "$slug" "$ver"
    return 2
  fi

  if ! command -v jq >/dev/null 2>&1; then
    printf "%s %s ERR(no-jq)\n" "$slug" "$ver"
    return 1
  fi

  # temps
  local expected_list expected_list_sorted expected_map
  local local_list_sorted miss_list mm_list extra_list
  expected_list="$(mktemp)"
  expected_list_sorted="$(mktemp)"
  expected_map="$(mktemp)"
  local_list_sorted="$(mktemp)"
  miss_list="$(mktemp)"
  mm_list="$(mktemp)"
  extra_list="$(mktemp)"

  # JSON shape matches your cache (like plugins): top-level {"files": { "path": {"md5": "..."} , ... }}
  if ! jq -r '.files | keys[]' "$cache" >"$expected_list"; then
    printf "%s %s ERR(bad-json)\n" "$slug" "$ver"
    rm -f "$expected_list" "$expected_list_sorted" "$expected_map" \
          "$local_list_sorted" "$miss_list" "$mm_list" "$extra_list"
    return 1
  fi
  jq -r '.files | to_entries[] | [.key, (.value.md5 // .value // "")] | @tsv' "$cache" >"$expected_map"
  LC_ALL=C sort -u "$expected_list" >"$expected_list_sorted"

  # local files (relative to theme dir)
  pushd "$theme_dir" >/dev/null || {
    printf "%s %s ERR(no-theme-dir)\n" "$slug" "$ver"
    rm -f "$expected_list" "$expected_list_sorted" "$expected_map" \
          "$local_list_sorted" "$miss_list" "$mm_list" "$extra_list"
    return 1
  }
  LC_ALL=C find . -type f -print | sed 's|^\./||' | LC_ALL=C sort -u >"$local_list_sorted"

  # Compare
  local missing=0 mismatched=0 extras=0 file expected_md5 actual_md5
  while IFS= read -r file; do
    if [[ ! -f "$file" ]]; then
      ((missing++)); echo "$file" >>"$miss_list"
    else
      expected_md5="$(awk -F'\t' -v f="$file" '$1==f{print $2; exit}' "$expected_map")"
      if [[ -n "$expected_md5" ]]; then
        actual_md5="$(md5sum -- "$file" | awk '{print $1}')"
        if [[ "$actual_md5" != "$expected_md5" ]]; then
          ((mismatched++)); echo "$file" >>"$mm_list"
        fi
      else
        ((missing++)); echo "$file" >>"$miss_list"
      fi
    fi
  done <"$expected_list_sorted"

  # Extras (local but not expected)
  LC_ALL=C comm -23 "$local_list_sorted" "$expected_list_sorted" >"$extra_list"
  extras="$(wc -l <"$extra_list" | awk '{print $1}')"

  popd >/dev/null || true

  # Result
  if (( missing==0 && mismatched==0 && extras==0 )); then
    printf "%s %s OK\n" "$slug" "$ver"
    rm -f "$expected_list" "$expected_list_sorted" "$expected_map" \
          "$local_list_sorted" "$miss_list" "$mm_list" "$extra_list"
    return 0
  else
    printf "%s %s FAIL missing=%d mismatched=%d extra=%d\n" "$slug" "$ver" "$missing" "$mismatched" "$extras"
    if [[ -n "${site_log:-}" ]]; then
      {
        ((missing))    && { echo "  [${slug} missing]";    sed 's/^/    - /' "$miss_list"; }
        ((mismatched)) && { echo "  [${slug} mismatched]"; sed 's/^/    - /' "$mm_list"; }
        ((extras))     && { echo "  [${slug} extra]";      sed 's/^/    - /' "$extra_list"; }
      } >>"$site_log"
    fi
    rm -f "$expected_list" "$expected_list_sorted" "$expected_map" \
          "$local_list_sorted" "$miss_list" "$mm_list" "$extra_list"
    return 1
  fi
}

#------------------------------------------------------------------------------
# Public API
#------------------------------------------------------------------------------

# Usage: theme_checksums_site "<site>"
theme_checksums_site() {

  local site="${1:-}"
  [[ -n "$site" ]] || { echo "theme_checksums_site: missing site"; return 1; }

  local arr="${CONFIG_SITES[$site]:-}"
  [[ -n "$arr" ]] || { echo "theme_checksums_site: site not loaded: $site"; return 1; }

  # Pull vars from loaded site map
  local LOCAL_SYNC_PATH THEME_CHECKSUMS LOCAL_DOCUMENT_ROOT LOCAL_WEBROOT LOCAL_THEMES_DIR
  LOCAL_SYNC_PATH="$(_get "$arr" LOCAL_SYNC_PATH)"
  THEME_CHECKSUMS="$(_get "$arr" THEME_CHECKSUMS)"
  LOCAL_DOCUMENT_ROOT="$(_get "$arr" LOCAL_DOCUMENT_ROOT)"
  LOCAL_WEBROOT="${LOCAL_SYNC_PATH}${LOCAL_DOCUMENT_ROOT}"
  LOCAL_THEMES_DIR="${LOCAL_WEBROOT}/wp-content/themes"

  local log_dir="logs/${EPOCH_TIMESTAMP}"
  local rep_dir="reports/${EPOCH_TIMESTAMP}"
  site_log="${log_dir}/${site}.log"
  local site_rep="${rep_dir}/${site}.report"
  mkdir -p "$log_dir" "$rep_dir"

  # Respect per-site toggle
  if [[ "${THEME_CHECKSUMS}" != "y" ]]; then
    echo "  theme checksums ${site} ... [SKIPPED]" | tee -a "$site_log"
    echo "THEME_CHECKSUMS=SKIPPED" >> "$site_rep"
    return 0
  fi

  [[ -d "$LOCAL_THEMES_DIR" ]] || {
    echo "  theme checksums ${site} ... [NO THEMES]" | tee -a "$site_log"
    echo "THEME_CHECKSUMS=NO_THEMES" >> "$site_rep"
    return 0
  }

  local rc_all=0
  shopt -s nullglob
  local d slug ver line rc
  for d in "$LOCAL_THEMES_DIR"/*/; do
    [[ -d "$d" ]] || continue
    slug="$(basename "${d%/}")"
    [[ "$slug" == .* ]] && continue

    ver="$(_tc_detect_theme_version "$d")"
    if [[ "$ver" == "unknown" || -z "$ver" ]]; then
      line="${slug} unknown FAIL version"
      echo "$line" | tee -a "$site_log"
      rc_all=1
      continue
    fi

    line="$(_tc_compare_from_cache "$d" "$slug" "$ver")"
    rc=$?
    echo "$line" | tee -a "$site_log"
    [[ $rc -eq 1 ]] && rc_all=1
  done

  if [[ $rc_all -eq 0 ]]; then
    echo "THEME_CHECKSUMS=OK" >> "$site_rep"
  else
    echo "THEME_CHECKSUMS=FAIL" >> "$site_rep"
  fi
}
# (EOF)
